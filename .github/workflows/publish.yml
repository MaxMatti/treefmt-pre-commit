name: Manual Publish to PyPI
on:
  push:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to publish (leave empty to auto-increment from latest tag)'
        required: false
        type: string
      create_release:
        description: 'Create GitHub release'
        required: false
        type: boolean
        default: false
permissions: {}
jobs:
  checks:
    name: Run Checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0 # Fetch all history for tags
      - name: Install uv
        uses: astral-sh/setup-uv@803947b9bd8e9f986429fa0c5a41c367cd732b41 # v7.2.1
      - name: Verify templates are in sync
        run: |
          uv run publish.py --dry-run
  publish:
    name: Build and Publish
    runs-on: ubuntu-latest
    needs: checks
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: write
      id-token: write # Required for PyPI trusted publishing
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: true
          fetch-depth: 0 # Fetch all history for tags
      - name: Install uv
        uses: astral-sh/setup-uv@803947b9bd8e9f986429fa0c5a41c367cd732b41 # v7.2.1
      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      - name: Run publish.py to bump version
        id: bump_version
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            echo "Using manual version: ${{ inputs.version }}"
            uv run publish.py --version "${{ inputs.version }}"
          else
            echo "Auto-incrementing version from latest tag"
            uv run publish.py
          fi

          # Get the new version
          VERSION=$(python3 -c "import tomllib; f=open('pyproject.toml','rb'); print(tomllib.load(f)['project']['version'])")
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "New version: $VERSION"
      - name: Push changes
        run: |
          git push origin main
          git push origin "v${{ steps.bump_version.outputs.VERSION }}"
      - name: Build wheels for all platforms
        run: |
          python3 build.py --version "${{ steps.bump_version.outputs.VERSION }}" --platform all --output-dir dist
      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/
      - name: Create GitHub release
        if: inputs.create_release
        run: |
          TAG_NAME="v${{ steps.bump_version.outputs.VERSION }}"

          # Check if release already exists
          if gh release view "$TAG_NAME" >/dev/null 2>&1; then
            echo "Release $TAG_NAME already exists, skipping release creation"
          else
            gh release create "$TAG_NAME" \
              --title "$TAG_NAME" \
              --notes "Release treefmt-pre-commit ${{ steps.bump_version.outputs.VERSION }}" \
              --latest
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
